<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Medaram Jathara Safety App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #sendBtn {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      background: #25D366;
      color: white;
      border: none;
      border-radius: 6px;
      z-index: 999;
    }
    #testToggle {
      position: fixed;
      top: 12px;
      left: 12px;
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 999;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
  </style>
</head>

<body>

<div id="map"></div>

<div id="testToggle">
  <input type="checkbox" id="testMode">
  <label for="testMode">Test Mode (Demo Only)</label>
</div>

<button id="sendBtn">SEND LOCATION VIA WHATSAPP</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================
   MEDARAM BOUNDARY (STAGE 2)
   ========================= */

const medaramBoundary = [
  [18.3082719,80.2423282],[18.3082023,80.2439178],[18.3088135,80.2458704],
  [18.3096283,80.2475656],[18.3107895,80.2484239],[18.3127354,80.2488194],
  [18.3140187,80.2494202],[18.3168697,80.2494201],[18.3182549,80.2507075],
  [18.3224919,80.25148],[18.3272991,80.2492484],[18.3342245,80.2523383],
  [18.3347133,80.2458152],[18.3391943,80.2380904],[18.3412311,80.2337989],
  [18.3402535,80.2234992],[18.3413126,80.2142295],[18.3376464,80.2082213],
  [18.3352022,80.2061614],[18.3316988,80.2091655],[18.3248535,80.2131887],
  [18.3207795,80.2179952],[18.3194758,80.2213426],[18.3178462,80.2270933],
  [18.3165425,80.2309128],[18.3147499,80.2331444],[18.3134462,80.2354189],
  [18.3116942,80.2382942],[18.3106757,80.2391096],[18.3091886,80.2402898],
  [18.3082719,80.2423282]
];

/* =========================
   HELPERS
   ========================= */

function getBounds(coords) {
  const lats = coords.map(p => p[0]);
  const lngs = coords.map(p => p[1]);
  return {
    minLat: Math.min(...lats),
    maxLat: Math.max(...lats),
    minLng: Math.min(...lngs),
    maxLng: Math.max(...lngs)
  };
}

function pointInPolygon(pt, poly) {
  let inside = false;
  for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
    const xi = poly[i][0], yi = poly[i][1];
    const xj = poly[j][0], yj = poly[j][1];
    const intersect =
      ((yi > pt[1]) !== (yj > pt[1])) &&
      (pt[0] < (xj - xi) * (pt[1] - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

/* =========================
   GRID LOGIC (ZONES & SUBZONES)
   ========================= */

function createGrid(bounds, rows, cols, prefix) {
  const result = [];
  const latStep = (bounds.maxLat - bounds.minLat) / rows;
  const lngStep = (bounds.maxLng - bounds.minLng) / cols;
  let n = 1;

  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      result.push({
        name: `${prefix} ${String(n++).padStart(2, '0')}`,
        polygon: [
          [bounds.minLat + r*latStep, bounds.minLng + c*lngStep],
          [bounds.minLat + r*latStep, bounds.minLng + (c+1)*lngStep],
          [bounds.minLat + (r+1)*latStep, bounds.minLng + (c+1)*lngStep],
          [bounds.minLat + (r+1)*latStep, bounds.minLng + c*lngStep]
        ]
      });
    }
  }
  return result;
}

/* =========================
   GPS + MAP
   ========================= */

navigator.geolocation.getCurrentPosition(pos => {

  let lat = pos.coords.latitude;
  let lng = pos.coords.longitude;

  // ---------- TEST MODE (ADDITION ONLY) ----------
  if (document.getElementById("testMode").checked) {
    lat = 18.3200;
    lng = 80.2300;
  }
  // -----------------------------------------------

  const map = L.map('map').setView([lat, lng], 15);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution: '© OpenStreetMap'
  }).addTo(map);

  L.marker([lat,lng]).addTo(map).bindPopup("You are here");

  const boundaryLayer = L.polygon(medaramBoundary,{
    color:'red',weight:2,fillOpacity:0.15
  }).addTo(map);

  map.fitBounds(boundaryLayer.getBounds());

  const insideMedaram = pointInPolygon([lat,lng], medaramBoundary);

  const zoneBounds = getBounds(medaramBoundary);
  const zones = createGrid(zoneBounds,4,4,"ZONE");

  zones.forEach(z=>{
    L.polygon(z.polygon,{color:'blue',weight:1,fillOpacity:0.05}).addTo(map);
  });

  let userZone = "N/A";
  let userSubzone = "N/A";

  if (insideMedaram) {
    zones.forEach(z=>{
      if(pointInPolygon([lat,lng],z.polygon)){
        userZone = z.name;

        const subBounds = getBounds(z.polygon);
        const subzones = createGrid(subBounds,4,4,"SUBZONE");

        subzones.forEach(sz=>{
          if(pointInPolygon([lat,lng],sz.polygon)){
            userSubzone = sz.name;
          }
        });
      }
    });
  }

  const statusText = insideMedaram
    ? "Inside Medaram Area"
    : "Outside Medaram Area";

  L.popup()
    .setLatLng([lat,lng])
    .setContent(`<b>${statusText}<br>${userZone} ${userSubzone}</b>`)
    .openOn(map);

  document.getElementById("sendBtn").onclick = () => {
    const gmap = `https://www.google.com/maps?q=${lat},${lng}`;
    const dir = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;

    const msg =
`Location Information (Medaram Jathara)

Status  : ${statusText}
Zone    : ${userZone}
Subzone : ${userSubzone}

Open Zone Map:
https://medaram-stage1.vercel.app

Directions to Reach:
${dir}

Live GPS Location:
${gmap}

${document.getElementById("testMode").checked ? "[TEST MODE – DEMO ONLY]\n" : ""}
Sent via Medaram Safety App`;

    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
  };

},
()=>alert("Please enable GPS"));

</script>
</body>
</html>
