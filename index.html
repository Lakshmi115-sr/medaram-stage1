<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Medaram Jathara Safety App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #sendBtn {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      background: #25D366;
      color: white;
      border: none;
      border-radius: 6px;
      z-index: 999;
    }

    /* INTRO SCREEN */
    #introScreen {
      position: fixed;
      inset: 0;
      background: url('intro.jpg') center/cover no-repeat;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #introOverlay {
      background: rgba(0,0,0,0.55);
      color: #fff;
      text-align: center;
      padding: 24px;
      max-width: 720px;
      margin: 16px;
      border-radius: 12px;
    }
    #introOverlay h1 {
      font-size: 26px;
      margin-bottom: 14px;
    }
    #introOverlay p {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 12px;
    }
    #introOverlay .footer {
      font-style: italic;
      margin-top: 14px;
      font-size: 14px;
    }
    #enterBtn {
      margin-top: 18px;
      padding: 12px 22px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      background: #ff9800;
      color: #000;
      cursor: pointer;
    }

    .zone-label {
      font-size: 14px;
      font-weight: bold;
      color: blue;
      background: rgba(255,255,255,0.8);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid blue;
      white-space: nowrap;
    }
    .subzone-label {
      font-size: 11px;
      font-weight: bold;
      color: green;
      background: rgba(255,255,255,0.85);
      padding: 1px 4px;
      border-radius: 3px;
      border: 1px solid green;
      white-space: nowrap;
    }
  </style>
</head>

<body>

<div id="introScreen">
  <div id="introOverlay">
    <h1>Welcome to Medaram Jathara Safety App</h1>

    <p>
      During Jathara rush, directions can be confusing.<br>
      This app shows your <b>Zone, Subzone, and nearest landmark</b><br>
      so you can <b>share your location in one tap via WhatsApp</b>.
    </p>

    <hr style="opacity:0.3">

    <p>
      <b>మెదారం జాతర భద్రతా యాప్‌కు స్వాగతం</b><br>
      జాతర రద్దీలో దారులు గందరగోళంగా ఉంటాయి.<br>
      ఈ యాప్ మీ <b>జోన్, సబ్‌జోన్, సమీప ల్యాండ్‌మార్క్</b> చూపిస్తుంది<br>
      తద్వారా మీ స్థలాన్ని <b>ఒక ట్యాప్‌లో WhatsApp ద్వారా పంచుకోవచ్చు</b>.
    </p>

    <div class="footer">
      Stay safe and stay connected<br>
      సురక్షితంగా ఉండండి – కనెక్ట్‌గా ఉండండి
    </div>

    <button id="enterBtn">Enter Map</button>
  </div>
</div>

<div id="map"></div>
<button id="sendBtn">SEND LOCATION VIA WHATSAPP</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
function playIntroVoice() {
  if (!('speechSynthesis' in window)) return;

  const telugu =
    "మెదారం జాతర భద్రతా యాప్‌కు స్వాగతం. " +
    "ఈ యాప్ ద్వారా మీరు మీ జోన్, సబ్‌జోన్, సమీప ల్యాండ్‌మార్క్ తెలుసుకోవచ్చు. " +
    "అవసరమైనప్పుడు మీ స్థలాన్ని సులభంగా పంచుకోవచ్చు. " +
    "సురక్షితంగా ఉండండి. కనెక్ట్‌గా ఉండండి.";

  const english =
    "Welcome to Medaram Jathara Safety App. " +
    "This app helps you know your zone, subzone, and nearest landmark, " +
    "so you can share your location easily. " +
    "Stay safe and stay connected.";

  const te = new SpeechSynthesisUtterance(telugu);
  te.lang = "te-IN";
  te.rate = 0.9;
  te.volume = 0.8;

  const en = new SpeechSynthesisUtterance(english);
  en.lang = "en-IN";
  en.rate = 0.9;
  en.volume = 0.8;

  speechSynthesis.cancel();
  speechSynthesis.speak(te);
  te.onend = () => speechSynthesis.speak(en);
}

setTimeout(playIntroVoice, 800);

document.getElementById("enterBtn").onclick = () => {
  document.getElementById("introScreen").style.display = "none";
  speechSynthesis.cancel();
};
</script>

<script>
/* =========================
   MEDARAM BOUNDARY
   ========================= */

const medaramBoundary = [
  [18.3082719,80.2423282],[18.3082023,80.2439178],[18.3088135,80.2458704],
  [18.3096283,80.2475656],[18.3107895,80.2484239],[18.3127354,80.2488194],
  [18.3140187,80.2494202],[18.3168697,80.2494201],[18.3182549,80.2507075],
  [18.3224919,80.25148],[18.3272991,80.2492484],[18.3342245,80.2523383],
  [18.3347133,80.2458152],[18.3391943,80.2380904],[18.3412311,80.2337989],
  [18.3402535,80.2234992],[18.3413126,80.2142295],[18.3376464,80.2082213],
  [18.3352022,80.2061614],[18.3316988,80.2091655],[18.3248535,80.2131887],
  [18.3207795,80.2179952],[18.3194758,80.2213426],[18.3178462,80.2270933],
  [18.3165425,80.2309128],[18.3147499,80.2331444],[18.3134462,80.2354189],
  [18.3116942,80.2382942],[18.3106757,80.2391096],[18.3091886,80.2402898],
  [18.3082719,80.2423282]
];

function getBounds(coords) {
  const lats = coords.map(p => p[0]);
  const lngs = coords.map(p => p[1]);
  return {
    minLat: Math.min(...lats),
    maxLat: Math.max(...lats),
    minLng: Math.min(...lngs),
    maxLng: Math.max(...lngs)
  };
}

function pointInPolygon(pt, poly) {
  let inside = false;
  for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
    const xi = poly[i][0], yi = poly[i][1];
    const xj = poly[j][0], yj = poly[j][1];
    const intersect =
      ((yi > pt[1]) !== (yj > pt[1])) &&
      (pt[0] < (xj - xi) * (pt[1] - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

function createGrid(bounds, rows, cols, prefix) {
  const result = [];
  const latStep = (bounds.maxLat - bounds.minLat) / rows;
  const lngStep = (bounds.maxLng - bounds.minLng) / cols;
  let n = 1;

  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      result.push({
        name: `${prefix} ${String(n++).padStart(2, '0')}`,
        polygon: [
          [bounds.minLat + r*latStep, bounds.minLng + c*lngStep],
          [bounds.minLat + r*latStep, bounds.minLng + (c+1)*lngStep],
          [bounds.minLat + (r+1)*latStep, bounds.minLng + (c+1)*lngStep],
          [bounds.minLat + (r+1)*latStep, bounds.minLng + c*lngStep]
        ]
      });
    }
  }
  return result;
}

async function getNearestLandmark(lat, lng) {
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.name) return data.name;
    if (data.address) {
      return (
        data.address.attraction ||
        data.address.amenity ||
        data.address.place ||
        data.address.road ||
        data.address.village ||
        data.address.hamlet ||
        "Forest Area"
      );
    }
    return "Forest Area";
  } catch {
    return "Forest Area";
  }
}

navigator.geolocation.getCurrentPosition(async pos => {

  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;

  const landmarkName = await getNearestLandmark(lat, lng);

  const map = L.map('map').setView([lat, lng], 15);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution: '© OpenStreetMap'
  }).addTo(map);

  L.marker([lat,lng]).addTo(map).bindPopup("You are here");

  const boundaryLayer = L.polygon(medaramBoundary,{
    color:'red',weight:2,fillOpacity:0.15
  }).addTo(map);

  map.fitBounds(boundaryLayer.getBounds());

  const insideMedaram = pointInPolygon([lat,lng], medaramBoundary);

  const zoneBounds = getBounds(medaramBoundary);
  const zones = createGrid(zoneBounds,4,4,"ZONE");

  const zoneLabelLayer = L.layerGroup().addTo(map);
  const subzoneLabelLayer = L.layerGroup().addTo(map);

  zones.forEach(z=>{
    L.polygon(z.polygon,{color:'blue',weight:1,fillOpacity:0.05}).addTo(map);

    const zb = getBounds(z.polygon);
    const zCenter = [(zb.minLat+zb.maxLat)/2,(zb.minLng+zb.maxLng)/2];
    L.marker(zCenter,{
      icon: L.divIcon({className:'zone-label',html:z.name})
    }).addTo(zoneLabelLayer);

    const subzones = createGrid(getBounds(z.polygon),4,4,"SUBZONE");
    subzones.forEach(sz=>{
      const sb = getBounds(sz.polygon);
      const sCenter = [(sb.minLat+sb.maxLat)/2,(sb.minLng+sb.maxLng)/2];
      L.marker(sCenter,{
        icon: L.divIcon({className:'subzone-label',html:sz.name})
      }).addTo(subzoneLabelLayer);
    });
  });

  function toggleSubzones(){
    if(map.getZoom() >= 17){
      map.addLayer(subzoneLabelLayer);
    } else {
      map.removeLayer(subzoneLabelLayer);
    }
  }
  map.on('zoomend', toggleSubzones);
  toggleSubzones();

  let userZone = "N/A";
  let userSubzone = "N/A";

  if (insideMedaram) {
    zones.forEach(z=>{
      if(pointInPolygon([lat,lng],z.polygon)){
        userZone = z.name;
        const subzones = createGrid(getBounds(z.polygon),4,4,"SUBZONE");
        subzones.forEach(sz=>{
          if(pointInPolygon([lat,lng],sz.polygon)){
            userSubzone = sz.name;
          }
        });
      }
    });
  }

  const statusText = insideMedaram ? "Inside Medaram Area" : "Outside Medaram Area";

  L.popup()
    .setLatLng([lat,lng])
    .setContent(
      `<b>${statusText}</b><br>
       ${userZone} – ${userSubzone}<br>
       Near : ${landmarkName}`
    )
    .openOn(map);

  document.getElementById("sendBtn").onclick = () => {
    const gmap = `https://www.google.com/maps?q=${lat},${lng}`;
    const dir = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;

    const msg =
`Location Information (Medaram Jathara)

Status  : ${statusText}
Zone    : ${userZone}
Subzone : ${userSubzone}
Near    : ${landmarkName}

Open Zone Map:
https://medaram-stage1.vercel.app

Directions to Reach:
${dir}

Live GPS Location:
${gmap}

Sent via Medaram Safety App`;

    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
  };

},
()=>alert("Please enable GPS"));
</script>

</body>
</html>
